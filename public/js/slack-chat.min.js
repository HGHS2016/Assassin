(function(c){var h={};window.slackChat=!1;var f={init:function(a){this._defaults={apiToken:"",channelId:"",user:"",userLink:"",userImg:"",userId:"",sysImg:"",sysUser:"",queryInterval:3E3,chatBoxHeader:"Need help? Talk to our support team right here",slackColor:"#36a64f",messageFetchCount:100,botUser:"",sendOnEnter:!0,disableIfAway:!1,elementToDisable:null,heightOffset:75,debug:!1,defaultUserImg:"",webCache:!1,privateChannel:!1,privateChannelId:!1,isOpen:!1,badgeElement:!1,serverApiGateway:"/server/php/server.php"};
this._options=c.extend(!0,{},this._defaults,a);this._options.queryIntElem=null;this._options.latest=null;this._options.debug&&console.log("This object :",this);window.slackChat._options=h=this._options;""==this._options.apiToken&&f.validationError("Parameter apiToken is required.");""!=this._options.channelId||this._options.privateChannel||f.validationError("Parameter channelId is required.");""==this._options.user&&f.validationError("Parameter user is required.");""==this._options.sysUser&&f.validationError("Parameter sysUser is required.");
""==this._options.botUser&&f.validationError("Parameter botUser is required.");"undefined"==typeof moment&&f.validationError("MomentJS is not available. Get it from http://momentjs.com");this._options.disableIfAway&&null!==this._options.elementToDisable&&this._options.elementToDisable.hide();a='<div class="slackchat slack-chat-box"><div class="slack-chat-header"><button class="close slack-chat-close">&times;</button>';a+=this._options.chatBoxHeader;a+="<div class='presence'><div class='presence-icon'>&#8226;</div><div class='presence-text'></div></div>";
a+="</div>";a+='<div class="slack-message-box">';a+="</div>";a+='<div class="send-area">';a+='<textarea class="form-control slack-new-message" disabled="disabled" type="text" placeholder="Hang tight while we connect..."></textarea>';a+='<div class="slack-post-message"><i class="fa fa-fw fa-chevron-right"></i></div>';a+="</div>";a+="</div>";c("body").append(a);var e=window.slackChat=this;c(this).on("click",function(){window.slackChat._options.badgeElement&&c(window.slackChat._options.badgeElement).html("").hide();
window.slackChat._options.privateChannel&&(window.slackChat._options.isOpen=!0);c(".slack-chat-box").show();c(".slack-chat-box").addClass("open");c(".slack-message-box").height(c(".slack-chat-box").height()-c(".desc").height()-c(".send-area").height()-parseInt(window.slackChat._options.heightOffset));!function b(){if(c(".slack-chat-box").hasClass("open")||window.slackChat._options.privateChannel)f.querySlack(e),setTimeout(b,window.slackChat._options.queryInterval)}();c(".slackchat .slack-new-message").focus();
window.slackChat._options.webCache&&(localStorage.scParams=JSON.stringify({apiToken:window.slackChat._options.apiToken,channelId:window.slackChat._options.channelId,user:window.slackChat._options.user,sysUser:window.slackChat._options.sysUser,botUser:window.slackChat._options.botUser}))});c(".slackchat .slack-chat-close").on("click",function(){c(".slack-chat-box").slideUp();c(".slack-chat-box").removeClass("open");window.slackChat._options.privateChannel?window.slackChat._options.isOpen=!1:clearInterval(window.slackChat._options.queryIntElem)});
c(".slackchat .slack-post-message").click(function(){f.postMessage(window.slackChat,window.slackChat._options)});c(".slackchat .slack-new-message").keyup(function(a){window.slackChat._options.sendOnEnter&&13==(a.keyCode?a.keyCode:a.which)&&(f.postMessage(window.slackChat,window.slackChat._options),a.preventDefault())});f.getUserPresence(window.slackChat,window.slackChat._options)},querySlack:function(a){options=window.slackChat._options;f.createChannel(a,function(a){window.slackChat._options.channelId=
a.id;c(".slack-new-message").prop("disabled",!1).prop("placeholder","Write a message...");c.ajax({url:"https://slack.com/api/channels.history",type:"POST",dataType:"json",data:{token:options.apiToken,channel:h.channelId,oldest:h.latest,count:options.messageFetchCount},success:function(a){options.debug&&a.messages&&a.messages.length&&console.log(a.messages);if(a.ok&&a.messages.length){var b="";window.slackChat._options.latest=a.messages[0].ts;a.messages=a.messages.reverse();for(var e=0,g=0;g<a.messages.length;g++)if("bot_message"==
a.messages[g].subtype&&""!==a.messages[g].text){message=a.messages[g];var k="",l="",h="";message.attachments&&(k=message.attachments[0].author_name,l=message.attachments[0].author_icon);message.fields&&(h=message.fields[0].value);var m=f.checkforLinks(message.text.trim()),b=b+"<div class='message-item'>";""!==l&&"undefined"!==typeof l?b+="<div class='userImg'><img src='"+l+"' /></div>":""!==options.defaultUserImg&&(b+="<div class='userImg'><img src='"+options.defaultUserImg+"' /></div>");b+="<div class='msgBox'>";
b=""!==h?b+("<div class='username'>"+(h==options.userId?"You":k)+"</div>"):b+("<div class='username'>"+k+"</div>");b+="<div class='message'>"+m+"</div>";"undefined"!==typeof moment&&(b+="<div class='timestamp'>"+moment.unix(a.messages[g].ts).fromNow()+"</div>");b+="</div>";b+="</div>"}else"undefined"==typeof a.messages[g].subtype&&(e++,message=a.messages[g].text,k=options.sysUser,m=f.checkforLinks(message),b+="<div class='message-item'>",""!==options.sysImg&&(b+="<div class='userImg'><img src='"+
options.sysImg+"' /></div>"),b+="<div class='msgBox'>",b+="<div class='username main'>"+k+"</div>",b+="<div class='message'>"+m+"</div>","undefined"!==typeof moment&&(b+="<div class='timestamp'>"+moment.unix(a.messages[g].ts).fromNow()+"</div>"),b+="</div>",b+="</div>");c(".slack-message-box").append(b);c(".slack-message-box").stop().animate({scrollTop:c(".slack-message-box")[0].scrollHeight},800);0<e&&!1===window.slackChat._options.isOpen&&window.slackChat._options.badgeElement&&c(window.slackChat._options.badgeElement).html(e).show()}else a.ok||
(console.log("[SlackChat] Query failed with errors: "),console.log(a))}})})},postMessage:function(a){a=a._options;var e={};e.fallback="View "+a.user+"'s profile";e.color=a.slackColor;e.author_name=a.user;""!==a.userLink&&(e.author_link=a.userLink);""!==a.userImg&&(e.author_icon=a.userImg);""!==a.userId&&(e.fields=[{title:"ID",value:a.userId,"short":!0}]);if(""===c(".slack-new-message").val().trim())return!1;message=c(".slack-new-message").val();c(".slack-new-message").val("");a.debug&&(console.log("Posting Message:"),
console.log({message:message,attachment:e,options:a}));c.ajax({url:"https://slack.com/api/chat.postMessage",type:"POST",dataType:"json",data:{token:a.apiToken,channel:window.slackChat._options.channelId,text:message,username:a.botUser,attachments:JSON.stringify([e])},success:function(a){a.ok||(c(".slack-new-message").val(message),console.log("[SlackChat] Post Message failed with errors: "),console.log(a))}})},validationError:function(a){c.error("[SlackChat Error] "+a);return!1},getUserPresence:function(a){var e=
a._options,d=!1,b=[];c.ajax({url:"https://slack.com/api/users.list",type:"POST",dataType:"json",data:{token:e.apiToken},success:function(a){if(a.ok&&(b=a.members,b.length))for(a=0;a<b.length&&!d;a++)b[a].is_bot||c.ajax({url:"https://slack.com/api/users.getPresence",dataType:"json",type:"POST",data:{token:e.apiToken,user:b[a].id},success:function(a){if(a.ok){if("active"===a.presence)return c(".slackchat .presence").addClass("active"),c(".slackchat .presence .presence-text").text("Available"),e.disableIfAway&&
null!==e.elementToDisable&&e.elementToDisable.show(),d=!0;d||(c(".slackchat .presence").removeClass("active"),c(".slackchat .presence .presence-text").text("Away"))}}})}})},destroy:function(a){c(a).unbind("click");c(".slackchat").remove()},checkforLinks:function(a){var c=0;if(/.*<[a-zA-Z0-9\/:\-.]+|[a-zA-Z0-9\/:\-.]+>.*/.test(a))for(;c<=a.indexOf("<http");){linkStartIndex=a.indexOf("<http");linkEndIndex=a.indexOf(">",linkStartIndex)+1;var d=a.substring(linkStartIndex,linkEndIndex),c=c+(linkStartIndex+
a.indexOf(">")+1),b,f;d.indexOf("|")?(b=d.substr(1,d.indexOf("|")-1),f=d.substring(d.indexOf("|")+1,d.length-1)):(b=d.substr(1,d.indexOf(">")-1),d.substring(d.indexOf(">")+1,d.length-1),f=b);a=a.replace(d,"<a href='"+b+"' target='_blank'>"+f+"</a>")}return a},createChannel:function(a,e){var d=a._options;if(!d.privateChannel){var b={id:d.channelId};e(b);return!1}if(d.privateChannelId)return b={id:d.privateChannelId},e(b),!1;b=d.user+"-"+(d.userId?d.userId:1E5*Math.random());c.ajax({url:d.serverApiGateway,
dataType:"json",type:"POST",data:{channelName:b},success:function(a){a.ok&&(d.privateChannelId=window.slackChat._options.privateChannelId=a.data.id,e(a.data));return!1},error:function(){return!1}})}};c.fn.slackChat=function(a){if(f[a])return f[a].apply(this,Array.prototype.slice.call(arguments,1));"object"!==typeof a&&a?c.error("Method "+a+" does not exist on jQuery.slackChat"):f.init.apply(this,arguments)}})(jQuery);